<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GravityRemote Mobile</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-hover: #252525;
            --border: #1f1f1f;
            --text-primary: #33ff33;
            --text-secondary: #228822;
            --accent-green: #33ff33;
            --accent-green-dark: #22aa22;
            --accent-red: #ff3333;
            --font-mono: 'Courier New', 'Monaco', monospace;
            --font-digital: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header - Ultra Compact */
        .header {
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-green);
            font-family: var(--font-mono);
            text-shadow: 0 0 8px var(--accent-green);
            cursor: pointer;
            user-select: none;
        }

        .brand::before {
            content: '◆';
            font-size: 20px;
        }

        /* Collapsible sections */
        .system-stats.collapsed,
        .control-panel.collapsed,
        .lisan-banners.collapsed {
            display: none;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 9px;
            font-family: var(--font-mono);
            color: var(--accent-green);
            text-shadow: 0 0 5px var(--accent-green);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--accent-green);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Control Panel - Compact */
        .control-panel {
            padding: 8px 10px;
            display: flex;
            gap: 6px;
        }

        .control-btn {
            flex: 1;
            padding: 8px 10px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .control-btn:active {
            transform: scale(0.98);
        }

        .btn-restart {
            background: linear-gradient(135deg, #116611 0%, #0a440a 100%);
            color: var(--accent-green);
            border: 1px solid var(--accent-green-dark);
            text-shadow: 0 0 5px var(--accent-green);
        }

        .btn-refresh {
            background: var(--bg-tertiary);
            color: var(--accent-green);
            border: 1px solid var(--accent-green-dark);
        }

        .btn-agent {
            background: linear-gradient(135deg, #114411 0%, #082808 100%);
            color: var(--accent-green);
            border: 1px solid var(--accent-green-dark);
            text-shadow: 0 0 5px var(--accent-green);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red) 0%, #cc0000 100%);
            color: white;
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 1px solid var(--border);
        }

        .chat-header {
            padding: 4px 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-green);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-mono);
            text-shadow: 0 0 5px var(--accent-green);
        }

        /* System Stats - 80s Digital */
        .system-stats {
            padding: 4px 10px;
            background: #050505;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 20px;
            font-family: var(--font-digital);
            font-size: 11px;
            color: var(--accent-green);
            text-shadow: 0 0 10px var(--accent-green);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: var(--accent-green-dark);
            font-size: 9px;
        }

        .stat-value {
            font-weight: bold;
            letter-spacing: 1px;
        }

        .agent-frame-wrapper {
            flex: 1;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .agent-frame-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
            filter: invert(0.88) hue-rotate(180deg);
        }

        /* Footer - Hidden for more space */
        .footer {
            display: none;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--accent-orange);
        }

        .modal-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-confirm {
            background: var(--accent-orange);
            color: white;
        }

        /* Loading Spinner */
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-secondary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Header Right Section */
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-badge {
            font-size: 9px;
            font-family: var(--font-mono);
            color: var(--accent-green);
            text-shadow: 0 0 5px var(--accent-green);
            text-transform: uppercase;
        }

        .live-badge {
            font-size: 9px;
            font-family: var(--font-mono);
            color: var(--accent-green);
            text-shadow: 0 0 8px var(--accent-green);
        }

        /* Lisan al-Arab Scrolling Text - Two Parallel Strips */
        .lisan-banners {
            background: #050505;
            border-bottom: 1px solid var(--border);
            padding: 2px 0;
            overflow: hidden;
        }

        .lisan-strip {
            overflow: hidden;
            white-space: nowrap;
            line-height: 1.2;
        }

        .lisan-strip-arabic {
            direction: rtl;
        }

        .lisan-strip-latin {
            direction: ltr;
        }

        .marquee-text {
            display: inline-block;
            padding-right: 50px;
            /* Animation handled by JavaScript for synchronized speed */
        }

        .marquee-arabic {
            font-size: 15px;
            font-family: 'Amiri', 'Traditional Arabic', 'Scheherazade', serif;
            color: var(--accent-green);
            text-shadow: 0 0 10px var(--accent-green), 0 0 20px var(--accent-green-dark);
            letter-spacing: 0;
            word-spacing: 8px;
        }

        .marquee-latin {
            font-size: 10px;
            font-family: var(--font-mono);
            color: #22cc22;
            text-shadow: 0 0 6px #22cc22;
            letter-spacing: 2px;
            word-spacing: 12px;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="header">
        <div class="brand" id="brand-toggle" onclick="toggleHeaders()">◆ GRAVITYREMOTE</div>
        <div class="header-right">
            <span class="agent-badge">Agent</span>
            <span id="conn-label" class="live-badge">● LIVE</span>
            <div class="status-badge">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">INIT</span>
            </div>
        </div>
    </header>

    <!-- System Stats - 80s Digital -->
    <div class="system-stats">
        <div class="stat-item">
            <span class="stat-label">CPU:</span>
            <span class="stat-value" id="cpu-stat">---%</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">RAM:</span>
            <span class="stat-value" id="ram-stat">---MB</span>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <button class="control-btn btn-restart" onclick="showRestartModal()">
            ⟳ Restart IDE
        </button>
        <button class="control-btn btn-agent" onclick="openAgentMode()">
            ⌨ Agent Mode
        </button>
        <button class="control-btn btn-refresh" onclick="refreshFrame()">
            ↻ Refresh
        </button>
    </div>

    <!-- Agent Chat -->
    <div class="chat-container">
        <!-- Lisan al-Arab Scrolling Text - Two Parallel Strips -->
        <div class="lisan-banners">
            <div class="lisan-strip lisan-strip-arabic">
                <span class="marquee-text marquee-arabic" id="lisan-arabic"></span>
            </div>
            <div class="lisan-strip lisan-strip-latin">
                <span class="marquee-text marquee-latin" id="lisan-latin"></span>
            </div>
        </div>
        <div class="agent-frame-wrapper">
            <iframe id="agent-frame" src="" allow="clipboard-read; clipboard-write"></iframe>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        Mobile Remote v1.0 • Port 8893 • Dark Mode
    </div>

    <!-- Restart Modal -->
    <div id="restart-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">⟳ Restart Antigravity IDE</div>
            <div class="modal-text">
                This will restart the Antigravity IDE process. The connection may be temporarily interrupted.
                <br><br>
                Are you sure you want to continue?
            </div>
            <div class="modal-actions">
                <button class="modal-cancel" onclick="hideRestartModal()">Cancel</button>
                <button class="modal-confirm" onclick="restartIDE()">
                    <span id="restart-spinner" class="spinner"></span>
                    <span id="restart-text">Restart</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        const agentFrame = document.getElementById('agent-frame');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const connLabel = document.getElementById('conn-label');

        // Use the server hostname instead of 127.0.0.1
        const PROXY_HOST = window.location.hostname;
        const PROXY_PORT = 8892;
        const PROXY_URL = `http://${PROXY_HOST}:${PROXY_PORT}`;

        // Set iframe source on load
        agentFrame.src = PROXY_URL;

        // Check connection status
        function checkConnection() {
            fetch(PROXY_URL, { mode: 'no-cors' })
                .then(() => {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'ONLINE';
                    connLabel.textContent = '● LIVE';
                })
                .catch(() => {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'OFFLINE';
                    connLabel.textContent = '○ DOWN';
                });
        }

        // Fetch and display system stats (80s style)
        async function updateSystemStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('cpu-stat').textContent = stats.cpu + '%';
                    document.getElementById('ram-stat').textContent = stats.ram + 'MB';
                }
            } catch (e) {
                document.getElementById('cpu-stat').textContent = 'ERR';
                document.getElementById('ram-stat').textContent = 'ERR';
            }
        }

        // Refresh the agent frame
        function refreshFrame() {
            agentFrame.src = PROXY_URL;
            showToast('REFRESHING...');
        }

        // Open Agent Mode (send Ctrl+E to IDE)
        async function openAgentMode() {
            showToast('ACTIVATING AGENT...');
            try {
                const response = await fetch('/api/agent-mode', { method: 'POST' });
                if (response.ok) {
                    showToast('AGENT MODE ON');
                    setTimeout(() => {
                        agentFrame.src = PROXY_URL;
                    }, 1000);
                } else {
                    showToast('AGENT FAIL');
                }
            } catch (e) {
                showToast('SIGNAL SENT');
            }
        }

        // Show restart modal
        function showRestartModal() {
            document.getElementById('restart-modal').classList.add('active');
        }

        // Hide restart modal
        function hideRestartModal() {
            document.getElementById('restart-modal').classList.remove('active');
        }

        // Restart IDE
        async function restartIDE() {
            const spinner = document.getElementById('restart-spinner');
            const text = document.getElementById('restart-text');

            spinner.classList.add('active');
            text.textContent = 'RESTARTING...';

            try {
                const response = await fetch('/api/restart-ide', { method: 'POST' });
                if (response.ok) {
                    showToast('IDE RESTART OK');
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    showToast('RESTART FAIL');
                }
            } catch (e) {
                showToast('SIGNAL SENT');
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
            }

            hideRestartModal();
            spinner.classList.remove('active');
            text.textContent = 'RESTART';
        }

        // Show toast message
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Toggle headers visibility
        let headersCollapsed = false;
        function toggleHeaders() {
            headersCollapsed = !headersCollapsed;
            document.querySelector('.system-stats').classList.toggle('collapsed', headersCollapsed);
            document.querySelector('.control-panel').classList.toggle('collapsed', headersCollapsed);
            document.querySelector('.lisan-banners').classList.toggle('collapsed', headersCollapsed);
        }

        // Initialize
        checkConnection();
        updateSystemStats();
        setInterval(checkConnection, 10000);
        setInterval(updateSystemStats, 3000);

        // ========================================
        // لِسَان العَرَب - Lisan al-Arab Streaming
        // ========================================

        // Lisan al-Arab sentences (from lisanclean.json)
        const lisanSentences = [
            "البَرْقُ سَرِيعُ اللَّمْعِ وَالبَاطِنُ ظَاهِرٌ فِي كُلِّ شَيْءٍ",
            "الأَدَبُ الَّذِي يَتَأَدَّبُ بِهِ الأَدِيبُ مِنَ النَّاسِ",
            "المِفْتَاحُ آلَةُ الفَتْحِ وَالشَّمْسَةُ عَلَامَةُ السِّرِّيَّةِ",
            "الإِنْتِشَارُ التَّفَرُّقُ وَالوَسْمُ أَثَرُ الكَيِّ",
            "أَجَأ جَبَلٌ لِطَيِّىءٍ يُذَكَّرُ وَيُؤَنَّثُ",
            "الأَبُّ الكَلَأُ وَالـمَرْعَى وَمَا تَعْتَلِفُهُ الـمَاشِيَةُ",
            "غَلاَّبةٌ لِلنَّاجِياتِ الغُلْبِ حَتَّى أَتَى أُزْبِيُّها بِالأَدْبِ",
            "الخَناذِيذُ رُؤُوسُ الجِبَالِ كَجِيدِ عَرُوسٍ مُتَبَذِّلَةٍ",
            "نَحْنُ فِي الـمَشْتَاةِ نَدْعُو الجَفَلى لا تَرَى الآدِبَ فِينَا يَنْتَقِرُ",
            "الإِرْبُ العُضْوُ الـمُوَفَّرُ الكَامِلُ الَّذِي لَمْ يَنقُصْ مِنْهُ شَيْءٌ"
        ];

        // Arabic consonants to Latin transliteration map
        const consonantMap = {
            'ا': 'ā', 'أ': 'a', 'إ': 'i', 'آ': 'ā',
            'ب': 'b', 'ت': 't', 'ث': 'th',
            'ج': 'j', 'ح': 'ḥ', 'خ': 'kh',
            'د': 'd', 'ذ': 'dh',
            'ر': 'r', 'ز': 'z',
            'س': 's', 'ش': 'sh',
            'ص': 'ṣ', 'ض': 'ḍ',
            'ط': 'ṭ', 'ظ': 'ẓ',
            'ع': 'ʿ', 'غ': 'gh',
            'ف': 'f', 'ق': 'q',
            'ك': 'k', 'ل': 'l',
            'م': 'm', 'ن': 'n',
            'ه': 'h', 'و': 'w',
            'ي': 'y', 'ى': 'ā',
            'ء': 'ʾ', 'ة': 'h',
            'ـ': '', // Tatweel (kashida)
        };

        // Arabic diacritics mapped to Unicode combining diacritics for Latin
        // These go ABOVE the previous Latin letter
        const diacriticMap = {
            'َ': 'a',   // Fatha → a
            'ِ': 'i',   // Kasra → i
            'ُ': 'u',   // Damma → u
            'ً': 'an',  // Fathatan → an
            'ٍ': 'in',  // Kasratan → in
            'ٌ': 'un',  // Dammatan → un
            'ْ': '',    // Sukun → nothing
            'ّ': '',    // Shadda → handled separately (double consonant)
        };

        // Check if character is an Arabic diacritic
        function isDiacritic(char) {
            return 'ًٌٍَُِّْ'.includes(char);
        }

        // Transliterate full Arabic text with diacritics applied to Latin letters
        function transliterateArabic(text) {
            let result = '';
            const chars = [...text];

            for (let i = 0; i < chars.length; i++) {
                const char = chars[i];

                // Skip diacritics - they're handled with the previous consonant
                if (isDiacritic(char)) continue;

                // Spaces and punctuation
                if (char === ' ' || char === '،' || char === '.') {
                    result += char === '،' ? ',' : char;
                    continue;
                }

                // Get the Latin consonant
                let latin = consonantMap[char];
                if (latin === undefined) {
                    // Unknown character - keep as is
                    result += char;
                    continue;
                }

                // Look ahead for diacritics
                let j = i + 1;
                while (j < chars.length && isDiacritic(chars[j])) {
                    const diac = chars[j];
                    if (diac === 'ّ') {
                        // Shadda - double the consonant
                        latin = latin + latin;
                    } else if (diacriticMap[diac]) {
                        // Append vowel after consonant
                        latin = latin + diacriticMap[diac];
                    }
                    j++;
                }

                result += latin;
            }
            // Reverse word order AND letters within each word for RTL alignment
            // Arabic (RTL): word1 word2 word3 (word1 on right)
            // Latin (LTR) reversed: 3drow 2drow 1drow (1drow on right matches word1)
            const words = result.split(' ').map(word => [...word].reverse().join(''));
            return words.reverse().join(' ');
        }

        // Current sentence index
        let currentLisanIndex = 0;

        // Update Lisan al-Arab banners with two parallel strips
        function updateLisanBanners() {
            const arabicEl = document.getElementById('lisan-arabic');
            const latinEl = document.getElementById('lisan-latin');
            if (!arabicEl || !latinEl) return;

            const sentence = lisanSentences[currentLisanIndex];
            const transliterated = transliterateArabic(sentence);

            // Build the text with diamond separators for continuous loop
            const diamond = ' ◆ ';
            arabicEl.textContent = sentence + diamond + sentence + diamond + sentence + diamond;
            latinEl.textContent = transliterated + diamond + transliterated + diamond + transliterated + diamond;

            // Cycle to next sentence
            currentLisanIndex = (currentLisanIndex + 1) % lisanSentences.length;
        }

        // Initialize Lisan banners
        updateLisanBanners();

        // Synchronized pixel-speed animation for both strips
        let scrollPosition = 0;
        const SCROLL_SPEED = 30; // pixels per second (slower = more readable)
        let lastTime = performance.now();

        function animateMarquee(currentTime) {
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            scrollPosition += SCROLL_SPEED * deltaTime;

            const arabicEl = document.getElementById('lisan-arabic');
            const latinEl = document.getElementById('lisan-latin');
            const container = document.querySelector('.lisan-banners');

            if (arabicEl && latinEl && container) {
                const containerWidth = container.offsetWidth;
                const arabicWidth = arabicEl.offsetWidth;

                // Reset when fully scrolled
                if (scrollPosition > arabicWidth + containerWidth) {
                    scrollPosition = 0;
                    updateLisanBanners();
                }

                // Apply same transform to both strips (both move left-to-right together)
                arabicEl.style.transform = `translateX(${scrollPosition}px)`;
                latinEl.style.transform = `translateX(${scrollPosition}px)`;
            }

            requestAnimationFrame(animateMarquee);
        }

        // Start animation
        requestAnimationFrame(animateMarquee);
    </script>
</body>

</html>